<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Latency Tester</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        h1 {
            color: #0f0;
            text-shadow: 0 0 10px #0f0;
        }
        .stats {
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            font-size: 18px;
        }
        .stat-label {
            color: #0a0;
        }
        .stat-value {
            font-weight: bold;
            color: #0f0;
            text-shadow: 0 0 5px #0f0;
        }
        .latency-high {
            color: #f00 !important;
            text-shadow: 0 0 5px #f00;
        }
        .latency-medium {
            color: #ff0 !important;
            text-shadow: 0 0 5px #ff0;
        }
        button {
            background: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            font-family: 'Courier New', monospace;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        button:hover {
            background: #0f0;
            color: #000;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .log {
            background: #000;
            border: 2px solid #0f0;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            font-size: 12px;
            margin: 20px 0;
        }
        .log-entry {
            margin: 2px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #0f0;
        }
        .status.connected {
            background: rgba(0, 255, 0, 0.1);
        }
        .status.disconnected {
            background: rgba(255, 0, 0, 0.1);
            border-color: #f00;
            color: #f00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“¡ NETWORK LATENCY TESTER</h1>

        <div id="status" class="status disconnected">
            ðŸ”´ DISCONNECTED
        </div>

        <div>
            <button id="connectBtn" onclick="connect()">CONNECT</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>DISCONNECT</button>
            <button id="pingBtn" onclick="sendPing()" disabled>SEND PING</button>
            <button id="autoPingBtn" onclick="toggleAutoPing()">START AUTO-PING (1/sec)</button>
        </div>

        <div class="stats">
            <h2>ðŸ“Š LATENCY STATISTICS</h2>
            <div class="stat-row">
                <span class="stat-label">Current RTT:</span>
                <span id="currentRtt" class="stat-value">--- ms</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Average RTT:</span>
                <span id="avgRtt" class="stat-value">--- ms</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Min RTT:</span>
                <span id="minRtt" class="stat-value">--- ms</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Max RTT:</span>
                <span id="maxRtt" class="stat-value">--- ms</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Packets Sent:</span>
                <span id="packetsSent" class="stat-value">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Packets Received:</span>
                <span id="packetsReceived" class="stat-value">0</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">Packet Loss:</span>
                <span id="packetLoss" class="stat-value">0%</span>
            </div>
        </div>

        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { MessageType } from './src/shared/messages.js';
        import { BinaryPacket } from './src/network/BinaryPacket.js';

        let ws = null;
        let pingTimestamps = new Map();
        let stats = {
            sent: 0,
            received: 0,
            rtts: [],
            min: Infinity,
            max: 0,
            current: 0
        };
        let autoPingInterval = null;

        window.connect = function() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;

            log(`Connecting to ${wsUrl}...`);
            ws = new WebSocket(wsUrl);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                log('âœ… Connected!');
                document.getElementById('status').innerHTML = 'ðŸŸ¢ CONNECTED';
                document.getElementById('status').className = 'status connected';
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('pingBtn').disabled = false;
            };

            ws.onclose = () => {
                log('ðŸ”´ Disconnected');
                document.getElementById('status').innerHTML = 'ðŸ”´ DISCONNECTED';
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('pingBtn').disabled = true;
                if (autoPingInterval) {
                    clearInterval(autoPingInterval);
                    autoPingInterval = null;
                    document.getElementById('autoPingBtn').textContent = 'START AUTO-PING (1/sec)';
                }
            };

            ws.onerror = (error) => {
                log(`âŒ Error: ${error.message}`);
            };

            ws.onmessage = (event) => {
                try {
                    const packet = BinaryPacket.decode(event.data);

                    if (packet.type === MessageType.PONG) {
                        const sentTime = packet.data.timestamp;
                        const now = Date.now();
                        const rtt = now - sentTime;

                        if (pingTimestamps.has(sentTime)) {
                            pingTimestamps.delete(sentTime);
                            stats.received++;
                            stats.current = rtt;
                            stats.rtts.push(rtt);
                            stats.min = Math.min(stats.min, rtt);
                            stats.max = Math.max(stats.max, rtt);

                            const latencyClass = rtt > 200 ? 'latency-high' : rtt > 100 ? 'latency-medium' : '';
                            log(`ðŸ“¥ PONG received! RTT: <span class="${latencyClass}">${rtt}ms</span>`);
                            updateStats();
                        }
                    }
                } catch (err) {
                    console.error('Failed to process message:', err);
                }
            };
        };

        window.disconnect = function() {
            if (ws) {
                ws.close();
                ws = null;
            }
        };

        window.sendPing = function() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                log('âŒ Not connected!');
                return;
            }

            const timestamp = Date.now();
            pingTimestamps.set(timestamp, true);
            stats.sent++;

            const packet = BinaryPacket.encode(MessageType.PING, { timestamp });
            ws.send(packet);

            log(`ðŸ“¤ PING sent at ${timestamp}`);
            updateStats();

            // Clean up old timestamps after 5 seconds
            setTimeout(() => {
                if (pingTimestamps.has(timestamp)) {
                    pingTimestamps.delete(timestamp);
                    updateStats();
                }
            }, 5000);
        };

        window.toggleAutoPing = function() {
            if (autoPingInterval) {
                clearInterval(autoPingInterval);
                autoPingInterval = null;
                document.getElementById('autoPingBtn').textContent = 'START AUTO-PING (1/sec)';
                log('â¸ï¸ Auto-ping stopped');
            } else {
                autoPingInterval = setInterval(sendPing, 1000);
                document.getElementById('autoPingBtn').textContent = 'STOP AUTO-PING';
                log('â–¶ï¸ Auto-ping started (1 ping/sec)');
            }
        };

        function updateStats() {
            document.getElementById('currentRtt').textContent = stats.current ? `${stats.current}ms` : '--- ms';

            const avg = stats.rtts.length > 0
                ? Math.round(stats.rtts.reduce((a, b) => a + b, 0) / stats.rtts.length)
                : 0;
            document.getElementById('avgRtt').textContent = avg ? `${avg}ms` : '--- ms';

            document.getElementById('minRtt').textContent = stats.min !== Infinity ? `${stats.min}ms` : '--- ms';
            document.getElementById('maxRtt').textContent = stats.max > 0 ? `${stats.max}ms` : '--- ms';
            document.getElementById('packetsSent').textContent = stats.sent;
            document.getElementById('packetsReceived').textContent = stats.received;

            const loss = stats.sent > 0 ? ((stats.sent - stats.received) / stats.sent * 100).toFixed(1) : '0';
            document.getElementById('packetLoss').textContent = `${loss}%`;

            // Color code current RTT
            const currentEl = document.getElementById('currentRtt');
            currentEl.className = 'stat-value';
            if (stats.current > 200) {
                currentEl.classList.add('latency-high');
            } else if (stats.current > 100) {
                currentEl.classList.add('latency-medium');
            }
        }

        function log(message) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
    </script>
</body>
</html>
