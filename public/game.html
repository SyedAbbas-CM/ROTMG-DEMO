<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RotMG-Demo – Game</title>
    <link rel="icon" type="image/png" href="assets/images/chars.png">
    <link rel="stylesheet" href="styles/gameUI.css">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; }
        #glCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; }
        #gameCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #loadingScreen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; }
        #loadingBar { width: 300px; height: 20px; background-color: #333; margin-top: 20px; border-radius: 10px; overflow: hidden; }
        #loadingProgress { width: 0%; height: 100%; background-color: #0f0; transition: width 0.3s ease; }
        #connectionStatus { position: absolute; top: 10px; right: 10px; padding: 5px 10px; background-color: rgba(0, 0, 0, 0.5); color: #fff; border-radius: 5px; font-family: Arial, sans-serif; }
        #playerStatus { position: absolute; top: 10px; left: 10px; padding: 5px 10px; background-color: rgba(0, 0, 0, 0.5); color: #fff; border-radius: 5px; font-family: Arial, sans-serif; }
        #controlsHelp { position: absolute; bottom: 10px; left: 10px; padding: 5px 10px; background-color: rgba(0, 0, 0, 0.7); color: #fff; border-radius: 5px; font-family: Arial, sans-serif; font-size: 12px; }

        /* Death Screen Styles */
        #death-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            pointer-events: auto;
            transition: background-color 1.5s ease-in;
        }

        #death-screen.visible {
            background-color: rgba(0, 0, 0, 1.0);
        }

        #death-screen .death-content {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 1s ease-in 1s, transform 1s ease-in 1s;
            text-align: center;
            color: #fff;
        }

        #death-screen.visible .death-content {
            opacity: 1;
            transform: translateY(0);
        }

        #death-screen .death-title {
            font-family: Arial, sans-serif;
            font-size: 48px;
            font-weight: bold;
            color: #ff0000;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
        }

        #death-screen .death-message {
            font-family: Arial, sans-serif;
            font-size: 20px;
            color: #ccc;
            margin-bottom: 40px;
        }

        #death-screen .respawn-button {
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            color: #fff;
            background-color: #ff0000;
            border: 2px solid #fff;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-family: Arial, sans-serif;
        }

        #death-screen .respawn-button:hover {
            background-color: #cc0000;
            transform: scale(1.05);
        }

        #death-screen .respawn-button:active {
            transform: scale(0.95);
        }

        /* Class selection on death screen */
        #death-screen .class-select-label {
            font-family: Arial, sans-serif;
            font-size: 16px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        #death-screen .class-select {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 30px;
            max-width: 400px;
        }
        #death-screen .class-btn {
            padding: 10px 16px;
            font-size: 14px;
            font-family: Arial, sans-serif;
            background: #222;
            border: 2px solid #444;
            border-radius: 4px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
        }
        #death-screen .class-btn:hover {
            border-color: #0f9;
            color: #fff;
        }
        #death-screen .class-btn.selected {
            border-color: #0f9;
            background: rgba(0, 255, 153, 0.2);
            color: #0f9;
        }

        /* Class Select Overlay (shown when reconnecting after death) */
        #class-select-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        #class-select-overlay.visible {
            opacity: 1;
        }
        #class-select-overlay .select-title {
            font-family: Arial, sans-serif;
            font-size: 36px;
            font-weight: bold;
            color: #0f9;
            margin-bottom: 10px;
        }
        #class-select-overlay .select-subtitle {
            font-family: Arial, sans-serif;
            font-size: 18px;
            color: #888;
            margin-bottom: 30px;
        }
        #class-select-overlay .class-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 600px;
            margin-bottom: 30px;
        }
        #class-select-overlay .class-option {
            padding: 20px 30px;
            font-size: 16px;
            font-family: Arial, sans-serif;
            background: #1a1a2e;
            border: 2px solid #333;
            border-radius: 8px;
            color: #ccc;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        #class-select-overlay .class-option:hover {
            border-color: #0f9;
            color: #fff;
            transform: scale(1.05);
        }
        #class-select-overlay .class-option.selected {
            border-color: #0f9;
            background: rgba(0, 255, 153, 0.15);
            color: #0f9;
        }
        #class-select-overlay .play-button {
            padding: 15px 50px;
            font-size: 20px;
            font-weight: bold;
            color: #000;
            background-color: #0f9;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        #class-select-overlay .play-button:hover {
            background-color: #0d8;
            transform: scale(1.05);
        }
    </style>
    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
          "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
        }
      }
    </script>
</head>
<body>
    <div id="loadingScreen">
        <h1>Loading Game...</h1>
        <div id="loadingBar"><div id="loadingProgress"></div></div>
    </div>
    <div id="connectionStatus">Connecting...</div>
    <div id="pingDisplay" style="position: absolute; top: 10px; right: 150px; padding: 5px 10px; background-color: rgba(0, 0, 0, 0.5); color: #0f0; border-radius: 5px; font-family: monospace; font-size: 14px;">--ms</div>
    <div id="playerStatus" style="display:none;">Initializing...</div>
    <div id="controlsHelp">WASD: Move | Click: Shoot | V: Switch View | F3: Debug | Shift+E: Sprite Editor | Shift+M: Map Editor | Shift+S: Sprite Test</div>
    <canvas id="glCanvas"></canvas>
    <canvas id="gameCanvas"></canvas>
    <div id="spriteEditorContainer" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000;">
        <button id="closeSpriteEditor" style="position:absolute; top:10px; right:10px; padding:6px 10px; font-size:16px;">✖</button>
        <iframe id="spriteEditorFrame" src="" style="width:100%; height:100%; border:none;"></iframe>
    </div>
    <div id="gameUIContainer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 50; background-color: transparent;"></div>

    <!-- Death Screen Overlay -->
    <div id="death-screen">
        <div class="death-content">
            <div class="death-title">YOU DIED</div>
            <div class="death-message">Your journey has ended...</div>
            <div class="class-select-label">Choose your class</div>
            <div class="class-select" id="death-class-select">
                <div class="class-btn" data-class="warrior">Warrior</div>
                <div class="class-btn" data-class="archer">Archer</div>
                <div class="class-btn" data-class="wizard">Wizard</div>
                <div class="class-btn" data-class="rogue">Rogue</div>
                <div class="class-btn" data-class="knight">Knight</div>
                <div class="class-btn" data-class="mage">Mage</div>
                <div class="class-btn" data-class="necromancer">Necromancer</div>
                <div class="class-btn" data-class="priest">Priest</div>
            </div>
            <button class="respawn-button" onclick="handleRespawn()">RESPAWN</button>
        </div>
    </div>

    <!-- Class Select Overlay (shown on reconnect if previous character died) -->
    <div id="class-select-overlay">
        <div class="select-title">Choose Your Class</div>
        <div class="select-subtitle">Your previous character has fallen. Start a new adventure!</div>
        <div class="class-grid" id="reconnect-class-select">
            <div class="class-option" data-class="warrior">Warrior</div>
            <div class="class-option" data-class="archer">Archer</div>
            <div class="class-option" data-class="wizard">Wizard</div>
            <div class="class-option" data-class="rogue">Rogue</div>
            <div class="class-option" data-class="knight">Knight</div>
            <div class="class-option" data-class="mage">Mage</div>
            <div class="class-option" data-class="necromancer">Necromancer</div>
            <div class="class-option" data-class="priest">Priest</div>
        </div>
        <button class="play-button" onclick="handleClassSelect()">PLAY</button>
    </div>

    <script type="module">
        console.log('[game.html] Module script is running');
        import { initGame } from './src/game/game.js';
        console.log('[game.html] initGame imported successfully');
        let loadingProgress = 0;
        const progressBar = document.getElementById('loadingProgress');
        const loadingScreen = document.getElementById('loadingScreen');
        const connectionStatus = document.getElementById('connectionStatus');
        function updateLoadingProgress(progress) {
            loadingProgress = progress;
            progressBar.style.width = `${loadingProgress}%`;
            if (loadingProgress >= 100) {
                setTimeout(() => { loadingScreen.style.display = 'none'; }, 500);
            }
        }
        function updateConnectionStatus(status) {
            connectionStatus.textContent = status;
            switch (status) {
                case 'Connected': connectionStatus.style.backgroundColor = 'rgba(0, 128, 0, 0.5)'; break;
                case 'Disconnected': connectionStatus.style.backgroundColor = 'rgba(255, 0, 0, 0.5)'; break;
                case 'Connecting...': connectionStatus.style.backgroundColor = 'rgba(255, 165, 0, 0.5)'; break;
                default: connectionStatus.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            }
        }
        window.updateLoadingProgress = updateLoadingProgress;
        window.updateConnectionStatus = updateConnectionStatus;
        window.updatePlayerStatus = (s)=>{ const el=document.getElementById('playerStatus'); if(el) el.textContent=s; };

        // Check for player credentials - redirect to menu if missing
        const urlParams = new URLSearchParams(window.location.search);
        const playerName = urlParams.get('name');
        const playerClass = urlParams.get('class') || 'warrior';

        // If no player name, check localStorage or redirect to menu
        if (!playerName) {
            const saved = localStorage.getItem('rotmg_player');
            if (saved) {
                // Redirect with saved credentials
                const player = JSON.parse(saved);
                const params = new URLSearchParams();
                params.set('name', player.name);
                if (player.email) params.set('email', player.email);
                params.set('class', player.class || 'warrior');
                window.location.href = 'game.html?' + params.toString();
            } else {
                // No credentials at all, go to menu
                window.location.href = 'menu.html';
            }
        }

        // Display player name in status area
        if (playerName) {
            const statusEl = document.getElementById('playerStatus');
            if (statusEl) {
                statusEl.textContent = playerName + ' (' + playerClass + ')';
                statusEl.style.display = 'block';
            }
        }

        // Death screen class selection
        let selectedRespawnClass = playerClass; // Default to current class

        // Initialize class selection on death screen
        document.querySelectorAll('#death-class-select .class-btn').forEach(btn => {
            // Pre-select current class
            if (btn.dataset.class === playerClass) {
                btn.classList.add('selected');
            }
            btn.addEventListener('click', () => {
                document.querySelectorAll('#death-class-select .class-btn').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedRespawnClass = btn.dataset.class;
                console.log('[CLIENT] Selected respawn class:', selectedRespawnClass);
            });
        });

        // Handle respawn button click
        window.handleRespawn = function() {
            console.log('[CLIENT] Respawn button clicked, class:', selectedRespawnClass);

            // Send respawn request to server with selected class
            if (window.networkManager) {
                window.networkManager.sendRespawn(selectedRespawnClass);
                console.log('[CLIENT] Sent respawn request with class:', selectedRespawnClass);

                // Update local character class
                if (window.gameState && window.gameState.character) {
                    window.gameState.character.class = selectedRespawnClass;
                }
            } else {
                console.error('[CLIENT] Cannot respawn: networkManager not available');
            }
        };

        // Reconnect class select overlay (shown when all characters are dead)
        let selectedReconnectClass = 'warrior';

        // Initialize class selection on reconnect overlay
        document.querySelectorAll('#reconnect-class-select .class-option').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('#reconnect-class-select .class-option').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedReconnectClass = btn.dataset.class;
                console.log('[CLIENT] Selected reconnect class:', selectedReconnectClass);
            });
        });
        // Pre-select warrior
        document.querySelector('#reconnect-class-select .class-option[data-class="warrior"]')?.classList.add('selected');

        // Handle class select play button
        window.handleClassSelect = function() {
            console.log('[CLIENT] Class selected for new character:', selectedReconnectClass);

            // Update localStorage with new class
            const saved = localStorage.getItem('rotmg_player');
            if (saved) {
                const player = JSON.parse(saved);
                player.class = selectedReconnectClass;
                localStorage.setItem('rotmg_player', JSON.stringify(player));
            }

            // Reload page with new class parameter
            const params = new URLSearchParams(window.location.search);
            params.set('class', selectedReconnectClass);
            window.location.href = 'game.html?' + params.toString();
        };

        // Function to start the game
        function startGame() {
            console.log('[game.html] Starting game initialization');
            let progress = 0;
            const loadingInterval = setInterval(() => {
                progress += 5;
                updateLoadingProgress(progress);
                if (progress >= 90) clearInterval(loadingInterval);
            }, 100);
            console.log('[game.html] About to call initGame()...');
            initGame().then(() => {
                console.log('[game.html] initGame() completed successfully');
                updateLoadingProgress(100);
                updateConnectionStatus('Connected');
            }).catch((error) => {
                console.error('[game.html] initGame() failed:', error);
                updateLoadingProgress(100);
                updateConnectionStatus('Error');
                alert('Failed to initialize the game. Please check the console for details.');
            });
        }

        // Start game when DOM is ready (handle both cases: before and after DOMContentLoaded)
        if (document.readyState === 'loading') {
            console.log('[game.html] DOM still loading, adding event listener...');
            document.addEventListener('DOMContentLoaded', startGame);
        } else {
            console.log('[game.html] DOM already loaded, starting game immediately...');
            startGame();
        }
        document.getElementById('closeSpriteEditor').addEventListener('click',()=>{
            document.getElementById('spriteEditorContainer').style.display='none';
        });
        document.addEventListener('keydown', (e) => {
            if (e.key === 'S' && e.shiftKey) window.open('test-sprites.html', '_blank');
            if (e.key === 'E' && e.shiftKey) window.open('tools/sprite-editor.html', '_blank');
            if (e.key === 'M' && e.shiftKey) window.open('tools/map-editor.html', '_blank');
        });
    </script>
</body>
</html>

